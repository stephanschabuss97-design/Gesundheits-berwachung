<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gesundheits-Logger (V0.8 – Liste Befunde + deleteRemoteBefund)</title>
<style>
  :root { --bg:#0b0c10; --card:#15171c; --fg:#e8e8e8; --muted:#9aa3af; --accent:#4f46e5; --warn:#f59e0b; --ok:#10b981; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--fg);-webkit-tap-highlight-color:transparent;touch-action:manipulation;overscroll-behavior-y:none}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,12,16,.95),rgba(11,12,16,.7));backdrop-filter:blur(6px);z-index:10;padding:10px 12px;border-bottom:1px solid #1f232b}
  h1{margin:0;font-size:20px}
  nav.tabs{display:flex;gap:8px;padding:8px 12px;position:sticky;top:54px;background:rgba(11,12,16,.9);backdrop-filter:blur(6px);z-index:11}
  nav.tabs button{flex:1;min-width:100px;touch-action:manipulation}
  main{padding:12px;position:relative;z-index:1}
  .card{background:var(--card);border:1px solid #242833;border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input, select, textarea {width:100%;padding:12px;border-radius:12px;border:1px solid #2b2f3a;background:#0f1116;color:var(--fg);font-size:16px}
  textarea{min-height:64px;resize:vertical}

  .small{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:600;color:white;background:#2b2f3a;cursor:pointer;touch-action:manipulation;transition: background .25s ease, color .25s ease, transform .06s ease, box-shadow .25s ease}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn:active{ transform: scale(0.98) }
  .btn.primary{background:var(--accent)}
  .btn.ghost{background:#0f1116;border:1px solid #2b2f3a;color:var(--fg)}
  .btn.warn{background:var(--warn);color:#1a1200}
  .btn.toggle.active{ background: var(--ok); color:#06110b; border-color: transparent; }

  .btn.flash{background:linear-gradient(90deg,var(--accent) 0%,#7c3aed 50%,var(--accent) 100%)!important;background-size:200% 100%;color:#fff!important;animation:flashGradient 1.2s ease forwards,flashPop .2s ease;box-shadow:0 6px 24px rgba(79,70,229,.35)}
  @keyframes flashGradient{0%{background-position:0% 50%}100%{background-position:100% 50%}}
  @keyframes flashPop{0%{transform:scale(1)}50%{transform:1.03}100%{transform:1}}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .spacer{flex:1}
  section.view{display:none}
  section.view.active{display:block}

  #doctorTable thead{position:sticky;top:0;background:#0f1116}
  #doctorCard .toolbar{border-bottom:1px solid #242833;padding-bottom:8px;margin-bottom:8px}

  @media print{
    body{background:white;color:black}
    header, nav.tabs, .toolbar, .card:not(#doctorCard), .fab-wrap, #chart {display:none !important}
    #doctorCard{border:none;box-shadow:none}
    #doctorTitle{font-size:18px;margin-bottom:10px}
    #doctorTable th, #doctorTable td{border:1px solid #999;padding:6px}
    #doctorTable{border:1px solid #999}
  }

  #err{position:fixed;left:8px;right:8px;bottom:8px;background:#3d0d0d;color:#fecaca;padding:8px 10px;border-radius:10px;display:none;z-index:9999}

  /* Panels */
  .panel{position:fixed;right:8px;bottom:8px;width:340px;max-height:70vh;overflow:auto;background:#0f1116;border:1px solid #2b2f3a;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.35);display:none;z-index:9998}
  .panel header{display:flex;gap:6px;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #2b2f3a}
  .panel h4{margin:0;font-size:14px}
  .panel .content{padding:10px;font-size:13px;line-height:1.45}
  #diag pre{margin:0;padding:8px;font-size:12px;white-space:pre-wrap}

  /* FABs */
  .fab-wrap{position:fixed;right:8px;bottom:8px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .fab{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid #2b2f3a;background:#0f1116;cursor:pointer}
  .fab:hover{box-shadow:0 8px 24px rgba(0,0,0,.35)}

  /* Tabellen */
/* --- Daily-Tabelle (#tblhealt) --- */
#tbl{width:100%; border-collapse:separate; border-spacing:0 8px;}
#tbl thead th{position:sticky; top:0; background:#0f1116; z-index:1;}
#tbl th, #tbl td{padding:14px 12px; font-size:14px; vertical-align:top;}
#tbl tbody tr td{background:#0f1116; border-top:1px solid #2b2f3a; border-bottom:1px solid #2b2f3a;}
#tbl tbody tr td:first-child{border-left:1px solid #2b2f3a; border-top-left-radius:12px; border-bottom-left-radius:12px;}
#tbl tbody tr td:last-child{border-right:1px solid #2b2f3a; border-top-right-radius:12px; border-bottom-right-radius:12px;}
#tbl td.center, #tbl th.center{ text-align:center; white-space:nowrap; }
#tbl td.nowrap, #tbl th.nowrap{ white-space:nowrap; }
#tbl td.notes{ max-width: 680px; white-space: normal; word-break: break-word; overflow-wrap:anywhere; line-height:1.4; }

/* --- Befund-Tabelle wie Daily (#tblReports) --- */
#tblReports{width:100%; border-collapse:separate; border-spacing:0 8px;}
#tblReports thead th{position:sticky; top:0; background:#0f1116; z-index:1;}
#tblReports th, #tblReports td{padding:14px 12px; font-size:14px; vertical-align:top;}
#tblReports tbody tr td{background:#0f1116; border-top:1px solid #2b2f3a; border-bottom:1px solid #2b2f3a;}
#tblReports tbody tr td:first-child{border-left:1px solid #2b2f3a; border-top-left-radius:12px; border-bottom-left-radius:12px;}
#tblReports tbody tr td:last-child{border-right:1px solid #2b2f3a; border-top-right-radius:12px; border-bottom-right-radius:12px;}

/* Helferklassen auch für #tblReports anwenden (wie bei #tbl) */
#tblReports td.center, #tblReports th.center{ text-align:center; white-space:nowrap; }
#tblReports td.nowrap, #tblReports th.nowrap{ white-space:nowrap; }
#tblReports td.notes{ max-width: 680px; white-space: normal; word-break: break-word; overflow-wrap:anywhere; line-height:1.4; }


  #doctorTable{width:100%; border-collapse:separate; border-spacing:0 8px;}
  #doctorTable th, #doctorTable td{padding:12px 10px;}
  #doctorTable tbody tr td{background:#0f1116; border-top:1px solid #2b2f3a; border-bottom:1px solid #2b2f3a;}
  #doctorTable tbody tr td:first-child{border-left:1px solid #2b2f3a; border-top-left-radius:12px; border-bottom-left-radius:12px;}
  #doctorTable tbody tr td:last-child{border-right:1px solid #2b2f3a; border-top-right-radius:12px; border-bottom-right-radius:12px;}

  .blockTitle{font-weight:800;margin:0 0 8px 0}

  /* Chart panel */
  #chart .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  #chart .controls > * {flex:1}
  #chart .controls .half{flex:0 0 calc(50% - 4px)}
  #chart svg{width:100%;height:260px;display:block;background:#0f1116;border:1px solid #2b2f3a;border-radius:10px}
  #chart .legend{display:flex;gap:10px;font-size:12px;color:var(--muted);margin-top:6px;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;border:1px solid #000}

  /* Busy overlay */
  #busy{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:99998}
  #busy .box{background:#10131a;border:1px solid #2b2f3a;border-radius:12px;padding:12px 16px;font-weight:600}
  body.is-busy #busy{display:flex}

  /* Segmented Control + helpers */
  .seg{display:flex;gap:8px;margin:8px 0 12px}
  .seg .seg-btn.active{background:var(--accent);color:#fff}
  .hidden{display:none!important}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <h1>Gesundheits-Logger</h1><span class="small">V0.8</span>
    <div class="spacer"></div>
    <button class="btn ghost" id="helpToggle" type="button">Hilfe</button>
    <button class="btn ghost" id="diagToggle" type="button">Log</button>
  </div>
</header>

<nav class="tabs">
  <button class="btn ghost" data-tab="capture" id="tab-capture" type="button">Erfassen</button>
  <button class="btn ghost" data-tab="list" id="tab-list" type="button">Liste</button>
  <button class="btn ghost" data-tab="doctor" id="tab-doctor" type="button">Arzt-Ansicht</button>
</nav>

<!-- Hilfe-Panel -->
<div id="help" class="panel" role="dialog" aria-modal="false" aria-labelledby="helpTitle">
  <header>
    <h4 id="helpTitle">Hilfe • Was soll ich ankreuzen?</h4>
    <button class="btn ghost" id="helpClose" type="button">×</button>
  </header>
  <div class="content">
    <strong>NSAR genommen</strong> ankreuzen, wenn du ein Schmerz-/Entzündungsmedikament der Klasse NSAR genommen hast.
    <ul>
      <li><em>Beispiele (AT, frei):</em> Ibuprofen, Diclofenac, Naproxen.</li>
      <li><em>Kombo-Achtung:</em> Viele „Erkältungs-/Kopfweh“-Mittel enthalten NSAR.</li>
      <li><em>Bei Nierenkrankheit:</em> NSAR möglichst vermeiden, Alternativen mit Arzt besprechen.</li>
    </ul>
  </div>
</div>

<!-- Diagnose-Panel -->
<div id="diag" class="panel" role="dialog" aria-modal="false" aria-labelledby="diagTitle">
  <header>
    <h4 id="diagTitle">Touch-Log</h4>
    <button class="btn ghost" id="diagClose" type="button">×</button>
  </header>
  <pre id="diagLog" class="content" style="margin:0"></pre>
</div>

<!-- Diagramm-Panel -->
<div id="chart" class="panel" role="dialog" aria-modal="false" aria-labelledby="chartTitle">
  <header>
    <h4 id="chartTitle">Diagramm</h4>
    <button class="btn ghost" id="chartClose" type="button">×</button>
  </header>
  <div class="content">
    <div class="controls">
      <select id="metricSel" class="half">
        <option value="bp">Blutdruck (Sys/Dia)</option>
        <option value="pulse">Puls</option>
        <option value="weight">Gewicht</option>
      </select>
      <label class="half" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="smoothChk"> Glätten
      </label>
      <button class="btn ghost half" id="refreshChart" type="button">Neu zeichnen</button>
      <button class="btn ghost half" id="savePng" type="button">PNG speichern</button>
    </div>
    <svg id="chartSvg" viewBox="0 0 640 280" preserveAspectRatio="none" role="img" aria-label="Werteverlauf"></svg>
    <div class="legend" id="chartLegend"></div>
    <div class="small" style="opacity:.7;margin-top:6px">Zeitraum: nutzt die <em>Arzt-Ansicht</em> (von/bis).</div>
  </div>
</div>

<div id="err"></div>
<div id="busy"><div class="box">⏳ Bitte warten…</div></div>

<main>
  <!-- Capture -->
  <section class="view active" id="capture">
    <!-- Segmented Control: Erfassen -->
    <div class="seg" id="seg-capture">
      <button class="btn ghost seg-btn active" data-mode="daily">Erfassen • Daily</button>
      <button class="btn ghost seg-btn" data-mode="befund">Erfassen • Befund</button>
    </div>

    <!-- Daily-Capture -->
    <section class="card" id="entry">
      <div class="row">
        <div style="flex:1">
          <label>Datum</label>
          <input type="date" id="date">
        </div>
      </div>

      <div class="card" style="margin:8px 0;background:#11131a;border-color:#232735">
        <h3 class="blockTitle">Morgens</h3>
        <div class="row">
          <div style="width:130px">
            <label>Uhrzeit</label>
            <input type="time" id="timeM" step="60">
          </div>
        </div>
        <div class="grid">
          <div><label>Systolisch (mmHg)</label><input type="number" id="sysM" inputmode="numeric" placeholder="z. B. 128"></div>
          <div><label>Diastolisch (mmHg)</label><input type="number" id="diaM" inputmode="numeric" placeholder="z. B. 82"></div>
          <div><label>Puls (bpm)</label><input type="number" id="pulseM" inputmode="numeric" placeholder="z. B. 66"></div>
        </div>
      </div>

      <div class="card" style="margin:8px 0;background:#11131a;border-color:#232735">
        <h3 class="blockTitle">Abends</h3>
        <div class="row">
          <div style="width:130px">
            <label>Uhrzeit</label>
            <input type="time" id="timeA" step="60">
          </div>
        </div>
        <div class="grid">
          <div><label>Systolisch (mmHg)</label><input type="number" id="sysA" inputmode="numeric" placeholder="z. B. 128"></div>
          <div><label>Diastolisch (mmHg)</label><input type="number" id="diaA" inputmode="numeric" placeholder="z. B. 82"></div>
          <div><label>Puls (bpm)</label><input type="number" id="pulseA" inputmode="numeric" placeholder="z. B. 66"></div>
        </div>
      </div>

      <div class="card" style="margin:8px 0;background:#11131a;border-color:#232735">
        <h3 class="blockTitle">Gewicht</h3>
        <div class="row">
          <div style="flex:1">
            <label>Gewicht (kg)</label>
            <input type="number" step="0.1" id="weightDay" inputmode="decimal" placeholder="z. B. 84.2">
          </div>
        </div>
      </div>

      <div class="card" style="margin:8px 0;background:#11131a;border-color:#232735">
        <h3 class="blockTitle">Kommentar</h3>
        <div class="row">
          <div style="flex:1">
            <textarea id="notesDay" placeholder="Allgemeiner Kommentar zum Tag (optional)"></textarea>
          </div>
        </div>
      </div>

      <div class="row" style="align-items:center; gap:8px; margin-top:4px">
        <button class="btn toggle" id="trainingToggle" type="button" aria-pressed="false">🏋 Training heute</button>
        <button class="btn toggle" id="sickToggle" type="button" aria-pressed="false">🤒 Krank (Forxiga pausiert)</button>
        <button class="btn toggle" id="valsartanMissToggle" type="button" aria-pressed="false">💊 Valsartan vergessen</button>
        <button class="btn toggle" id="forxigaMissToggle" type="button" aria-pressed="false">💊 Forxiga vergessen</button>
        <button class="btn toggle" id="lowIntakeToggle" type="button" aria-pressed="false">🥤 &lt; 2 L getrunken</button>
        <button class="btn toggle" id="nsarToggle" type="button" aria-pressed="false" title="Nicht-steroidale Antirheumatika">🧪 NSAR genommen</button>
        <div class="spacer"></div>
      </div>

      <div class="row" style="align-items:center; gap:8px; margin-top:12px">
        <button class="btn primary" id="saveAllBtn" type="button">💾 Speichern</button>
        <div class="spacer"></div>
      </div>
    </section>

    <!-- Befund-Capture -->
    <section class="card hidden" id="entry_befund">
      <h3 class="blockTitle">Neuer Befund</h3>
      <div class="grid">
        <div><label>Datum</label><input type="date" id="repDate"></div>
        <div><label>Kreatinin (mg/dL)</label><input type="number" step="0.01" id="repKrea"></div>
        <div><label>eGFR (ml/min/1.73m²)</label><input type="number" step="1" id="repEgfr"></div>
        <div><label>uACR (mg/g)</label><input type="number" step="1" id="repUacr"></div>
        <div><label>Kalium (mmol/L)</label><input type="number" step="0.1" id="repK"></div>
        <div><label>Kommentar</label><input type="text" id="repNote" placeholder="Labor / Kontext"></div>
      </div>
      <div class="row" style="align-items:center; gap:8px; margin-top:12px">
        <button class="btn primary" id="saveReportBtn" type="button">💾 Befund speichern</button>
        <div class="spacer"></div>
      </div>
    </section>
  </section>

  <!-- List -->
  <section class="view" id="list">
    <section class="card">
      <div class="toolbar">
        <strong>Deine Einträge (Bearbeiten/Export)</strong>
        <div class="spacer"></div>
        <select id="rangeSel">
          <option value="all">alle</option>
          <option value="7">letzte 7 Tage</option>
          <option value="30">letzte 30 Tage</option>
          <option value="90">letzte 90 Tage</option>
        </select>
        <button class="btn ghost" id="exportCsv" type="button">Export CSV</button>
        <button class="btn ghost" id="exportJson" type="button">Export JSON</button>
        <button class="btn ghost" id="syncBtn" type="button" title="Sicherung + Neu laden von Supabase">↕ Sync (Daily)</button>
        <button class="btn warn" id="wipeBtn" type="button" title="Nur auf diesem Gerät">Alle lokal löschen (Daily)</button>
      </div>

      <!-- Segmented Control: List -->
      <div class="seg" id="seg-list">
        <button class="btn ghost seg-btn active" data-mode="daily">Liste • Daily</button>
        <button class="btn ghost seg-btn" data-mode="befund">Liste • Befunde</button>
      </div>

      <!-- Wrapper Daily -->
      <div style="overflow:auto" id="listDailyWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="nowrap">Datum</th>
              <th class="nowrap">Zeit</th>
              <th>Art</th>
              <th class="center nowrap">Syst</th>
              <th class="center nowrap">Diast</th>
              <th class="center nowrap">Puls</th>
              <th class="center nowrap">Gewicht</th>
              <th class="center nowrap">MAP</th>
              <th>Notizen</th>
              <th class="center nowrap">Training</th>
              <th class="center nowrap">&lt; 2 L</th>
              <th class="center nowrap">Krank</th>
              <th class="center nowrap">Valsartan ❌</th>
              <th class="center nowrap">Forxiga ❌</th>
              <th class="center nowrap">NSAR</th>
              <th class="center nowrap" title="Mit Server synchronisiert?">Cloud</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Wrapper Befunde -->
      <div style="overflow:auto" id="listReportWrap" class="hidden">
<table id="tblReports">
  <thead>
    <tr>
      <th class="nowrap">Datum</th>
      <th class="center">Kreatinin</th>
      <th class="center">eGFR</th>
      <th class="center">uACR</th>
      <th class="center">Kalium</th>
      <th>Kommentar</th>
      <th class="center">Cloud</th>
      <th class="nowrap">Aktion</th>

    </tr>
  </thead>

          <tbody></tbody>
        </table>
      </div>

      <div class="small" style="margin-top:6px">Dies ist deine Arbeitsliste. Die Arzt-Ansicht ist separat und druckfertig.</div>
    </section>

    <!-- Webhook-Konfiguration -->
    <section class="card">
      <h3 class="blockTitle">Webhook / Supabase (Konfiguration)</h3>
      <div class="grid">
        <div><label>Webhook URL (health_entries)</label><input type="url" id="whUrl" placeholder="https://XYZ.supabase.co/rest/v1/health_entries"></div>
        <div><label>API Key (Bearer)</label><input type="text" id="whKey" placeholder="Bearer ey..."></div>
        <div><label>Webhook URL (medical_reports)</label><input type="url" id="whUrlMr" placeholder="https://XYZ.supabase.co/rest/v1/medical_reports"></div>
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <button class="btn primary" id="saveWebhook" type="button">Speichern</button>
        <span id="whSaved" class="small" style="margin-left:8px"></span>
        <div class="spacer"></div>
        <button class="btn ghost" id="chartBtn" type="button">Diagramm öffnen</button>
      </div>
    </section>
  </section>

  <!-- Doctor -->
  <section class="view" id="doctor">
    <section class="card" id="doctorCard">
      <div class="toolbar">
        <strong id="doctorTitle">Arzt-Ansicht • Daily</strong>
        <div class="spacer"></div>
        <label class="small">Von <input type="date" id="from" style="width:auto"></label>
        <label class="small">Bis <input type="date" id="to" style="width:auto"></label>
        <button class="btn ghost" id="applyRange" type="button">Anwenden</button>
        <button class="btn ghost" id="printBtn" type="button">Drucken</button>
      </div>
      <div style="overflow:auto">
        <table id="doctorTable">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Zeit</th>
              <th>Art</th>
              <th>Sys</th>
              <th>Dia</th>
              <th>Puls</th>
              <th>MAP</th>
              <th>Gewicht</th>
              <th>Notizen</th>
              <th>&lt; 2 L</th>
              <th>Krank</th>
              <th>Valsartan ❌</th>
              <th>Forxiga ❌</th>
              <th>NSAR</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" style="margin-top:6px">Hinweis: Befund-Ansicht für den Arzt kommt als nächstes (separater Toggle).</div>
    </section>
  </section>
</main>

<!-- einfache FABs -->
<div class="fab-wrap">
  <div class="fab" id="helpToggleFab" title="Hilfe">❓</div>
  <div class="fab" id="diagToggleFab" title="Log">🧪</div>
</div>

<script>
/* ===== Fehlerbox ===== */
window.addEventListener('error', function(e){
  const box = document.getElementById('err');
  box.style.display='block';
  box.textContent = 'Fehler: ' + (e.message || e);
});

/* ===== Diagnostics ===== */
const diag = { el:null, logEl:null, open:false, lines:[],
  add(msg){ const t=new Date().toLocaleTimeString(); this.lines.unshift(`[${t}] ${msg}`); this.lines=this.lines.slice(0,50); if(this.logEl) this.logEl.textContent = this.lines.join('\n'); },
  init(){ this.el=document.getElementById('diag'); this.logEl=document.getElementById('diagLog');
    const t1=document.getElementById('diagToggle'); const t2=document.getElementById('diagToggleFab');
    const close=document.getElementById('diagClose');
    const toggle=()=>{ this.open=!this.open; this.el.style.display=this.open?'block':'none'; };
    t1.addEventListener('click', toggle, {passive:true});
    t2.addEventListener('click', toggle, {passive:true});
    close.addEventListener('click', ()=>{ this.open=false; this.el.style.display='none'; }, {passive:true});
  }
};

/* ===== Help panel ===== */
const helpPanel={ el:null, open:false,
  init(){ this.el=document.getElementById('help');
    const t1=document.getElementById('helpToggle'); const t2=document.getElementById('helpToggleFab'); const close=document.getElementById('helpClose');
    const toggle=()=>{ this.open=!this.open; this.el.style.display=this.open?'block':'none'; };
    t1.addEventListener('click', toggle, {passive:true});
    t2.addEventListener('click', toggle, {passive:true});
    close.addEventListener('click', ()=>{ this.open=false; this.el.style.display='none'; }, {passive:true});
  }
};

/* ===== Helpers ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmtNum = (n, d=1) => (n===null||n===undefined||isNaN(n)) ? "" : Number(n).toFixed(d);
const pad2 = n => n.toString().padStart(2,'0');
const todayStr = () => { const d = new Date(); return d.toISOString().slice(0,10); };
const timeStr = () => { const d = new Date(); return pad2(d.getHours())+":"+pad2(d.getMinutes()); };
function esc(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function nl2br(s){ return esc(s).replace(/\n/g, "<br>"); }
function calcMAP(sys, dia){ if (sys==null || dia==null) return null; return Number(dia) + (Number(sys)-Number(dia))/3; }
function setBusy(on){ document.body.classList.toggle('is-busy', !!on); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* Sanfte Werte-Warnung (rein visuell) */
function softWarnRange(input, min, max){
  const v = Number(input.value);
  const bad = input.value && (isNaN(v) || v < min || v > max);
  input.style.borderColor = bad ? "#f59e0b" : "#2b2f3a";
  input.title = bad ? `Ungewöhnlicher Wert (${min}–${max})` : "";
}

/* ===== IndexedDB ===== */
let db;
const DB_NAME="healthlog_db"; const STORE="entries"; const CONF="config";
function initDB(){
  return new Promise((resolve,reject)=>{
    // Version 3 (Store "reports")
    const req = indexedDB.open(DB_NAME, 3);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        const s = db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});
        s.createIndex("byDateTime","dateTime",{unique:false});
      } else {
        try{ db.transaction(STORE,"versionchange").objectStore(STORE).createIndex("byDateTime","dateTime",{unique:false}); }catch(_){}
      }
      if(!db.objectStoreNames.contains(CONF)){ db.createObjectStore(CONF,{keyPath:"key"}); }
      if(!db.objectStoreNames.contains("reports")){
        const r = db.createObjectStore("reports",{keyPath:"id",autoIncrement:true});
        r.createIndex("byDate","datum",{unique:false});
      }
    };
    req.onsuccess = (e)=>{ db = e.target.result; resolve(); };
    req.onerror = (e)=> reject(e);
  });
}
function putConf(key, value){
  return new Promise((res,rej)=>{
    const tx = db.transaction(CONF, "readwrite");
    tx.objectStore(CONF).put({key, value});
    tx.oncomplete = ()=>res();
    tx.onerror = (e)=>rej(e);
  });
}
function getConf(key){
  return new Promise((res,rej)=>{
    const tx = db.transaction(CONF, "readonly");
    const req = tx.objectStore(CONF).get(key);
    req.onsuccess = ()=> res(req.result?.value ?? null);
    req.onerror = (e)=> rej(e);
  });
}
function addEntry(obj){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,"readwrite");
    const req = tx.objectStore(STORE).add(obj);
    req.onsuccess = ()=> res(req.result);
    req.onerror = (e)=> rej(e);
  });
}
function updateEntry(id, patch){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,"readwrite");
    const store = tx.objectStore(STORE);
    const getReq = store.get(id);
    getReq.onsuccess = ()=>{
      const cur = getReq.result; if(!cur){ res(false); return; }
      const next = Object.assign({}, cur, patch);
      store.put(next);
    };
    tx.oncomplete = ()=>res(true);
    tx.onerror = (e)=>rej(e);
  });
}
function getAllEntries(){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,"readonly");
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = ()=> res(req.result || []);
    req.onerror = (e)=> rej(e);
  });
}
function deleteEntryLocal(id){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = ()=>res();
    tx.onerror = (e)=>rej(e);
  });
}
function wipeAll(){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).clear();
    tx.oncomplete = ()=>res();
    tx.onerror = (e)=>rej(e);
  });
}

/* ===== Reports (Befunde) ===== */
function addReport(obj){
  return new Promise((res,rej)=>{
    const tx = db.transaction("reports","readwrite");
    const req = tx.objectStore("reports").add(obj);
    req.onsuccess = ()=> res(req.result);
    req.onerror = (e)=> rej(e);
  });
}
function updateReport(id, patch){
  return new Promise((res,rej)=>{
    const tx = db.transaction("reports","readwrite");
    const store = tx.objectStore("reports");
    const getReq = store.get(id);
    getReq.onsuccess = ()=>{
      const cur = getReq.result; if(!cur){ res(false); return; }
      store.put(Object.assign({}, cur, patch));
    };
    tx.oncomplete = ()=>res(true);
    tx.onerror = (e)=>rej(e);
  });
}
function getAllReports(){
  return new Promise((res,rej)=>{
    const tx = db.transaction("reports","readonly");
    const req = tx.objectStore("reports").getAll();
    req.onsuccess = ()=> res(req.result || []);
    req.onerror = (e)=> rej(e);
  });
}
function deleteReportLocal(id){
  return new Promise((res,rej)=>{
    const tx = db.transaction("reports","readwrite");
    tx.objectStore("reports").delete(id);
    tx.oncomplete = ()=>res();
    tx.onerror = (e)=>rej(e);
  });
}

/* ===== Remote (Supabase REST) ===== */
async function getHeaders(){
  const key = await getConf("webhookKey");
  if(!key) return null;
  const apiKey = key.replace(/^Bearer\s+/i,"");
  const authHeader = key.trim().toLowerCase().startsWith("bearer ") ? key.trim() : `Bearer ${apiKey}`;
  return {
    "Content-Type":"application/json",
    "apikey": apiKey,
    "Authorization": authHeader,
    "Prefer":"return=representation"
  };
}
async function deleteRemote(remote_id){
  const url = await getConf("webhookUrl");
  const headers = await getHeaders();
  if(!url || !headers || !remote_id) return {ok:false};
  const q = `${url}?id=eq.${encodeURIComponent(remote_id)}`;
  try{
    const res = await fetch(q, { method:"DELETE", headers });
    return {ok: res.ok, status: res.status};
  }catch(e){
    return {ok:false, status:0};
  }
}
async function pullAllFromRemote(){
  const url = await getConf("webhookUrl");
  const headers = await getHeaders();
  if(!url || !headers) throw new Error("Webhook nicht konfiguriert");
  const q = `${url}?select=*&order=ts.asc`;
  const res = await fetch(q, { headers });
  if(!res.ok) throw new Error(`Fetch fehlgeschlagen (${res.status})`);
  return res.json();
}
async function pushPendingToRemote(){
  const url = await getConf("webhookUrl");
  const headers = await getHeaders();
  if(!url || !headers) return { pushed:0, failed:0 };
  const all = await getAllEntries();
  const pending = all.filter(e=>!e.remote_id);
  let pushed=0, failed=0;

  for(const e of pending){
    try{
      const res = await fetch(url, { method:"POST", headers, body: JSON.stringify(e) });
      if(!res.ok){ failed++; continue; }
      const json = await res.json();
      const rid = json?.[0]?.id;
      if(rid){ await updateEntry(e.id, { remote_id: rid }); pushed++; }
      else { failed++; }
      await sleep(50);
    }catch(_){ failed++; }
  }
  return { pushed, failed };
}

/* ===== Remote für Befunde ===== */
async function syncReportWebhook(report, localId){
  const url = await getConf("webhookUrlMr");
  const headers = await getHeaders();
  if(!url || !headers) return;
  try{
    const res = await fetch(url, { method:"POST", headers, body: JSON.stringify(report) });
    if(!res.ok){ diag.add(`MR-POST Fehler ${res.status}`); return; }
    const json = await res.json();
    const remoteId = json?.[0]?.id;
    if(remoteId){ await updateReport(localId, { remote_id: remoteId }); diag.add("Befund: Webhook OK"); }
  }catch(e){ diag.add("Befund: Netzwerkfehler"); }
}
async function deleteRemoteBefund(remote_id){
  const url = await getConf("webhookUrlMr");
  const headers = await getHeaders();
  if(!url || !headers || !remote_id) return {ok:false};
  const q = `${url}?id=eq.${encodeURIComponent(remote_id)}`;
  try{
    const res = await fetch(q, { method:"DELETE", headers });
    return {ok: res.ok, status: res.status};
  }catch(e){
    return {ok:false, status:0};
  }
}

/* ===== CSV/JSON export (Daily) ===== */
function toCSV(entries){
  const header = ["Datum","Uhrzeit","Art","Systolisch","Diastolisch","Puls","Gewicht_kg","MAP","Notizen","Training","Unter_2L","Krank","Valsartan_vergessen","Forxiga_vergessen","NSAR_genommen","ISODateTime","ID","REMOTE_ID"];
  const rows = entries.map(e=>{
    const isTrainingOnly = e.training && (!e.sys && !e.dia && !e.pulse && !e.weight);
    const art   = isTrainingOnly ? "Training" : "Messung";
    const notes = (isTrainingOnly ? ("🏋 Training" + (e.notes ? " – " + e.notes : "")) : (e.notes || "")).replace(/\n/g," ");
    return [
      e.date, e.time, art,
      isTrainingOnly ? "" : (e.sys??""),
      isTrainingOnly ? "" : (e.dia??""),
      isTrainingOnly ? "" : (e.pulse??""),
      isTrainingOnly ? "" : (e.weight??""),
      isTrainingOnly ? "" : (e.map??""),
      notes,
      e.training ? "Ja" : "",
      e.low_intake ? "Ja" : "",
      e.sick ? "Ja":"", 
      e.valsartan_missed ? "Ja" : "", 
      e.forxiga_missed ? "Ja" : "",
      e.nsar_taken ? "Ja" : "",
      e.dateTime, 
      e.id,
      e.remote_id ?? ""
    ];
  });
  const csv = [header.join(","), ...rows.map(r=>r.map(v=> (typeof v==="string" && /[",\n]/.test(v)) ? `"${v.replace(/"/g,'""')}"` : v).join(","))].join("\n");
  return csv;
}
function dl(filename, content, mime){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content], {type:mime}));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== List rendering (Daily) ===== */
function withinDays(dateISO, days){
  if (days==="all") return true;
  const d = new Date(dateISO+"T00:00:00");
  const now = new Date(); const diff = (now - d)/(1000*60*60*24);
  return diff <= Number(days);
}
function compareForList(a, b){
  if (a.date !== b.date) return a.date < b.date ? 1 : -1;
  if (a.time < b.time) return -1;
  if (a.time > b.time) return 1;
  return 0;
}
function renderTable(entries){
  const days = $("#rangeSel").value;
  const tbody = $("#tbl tbody");
  tbody.innerHTML = "";
  entries
    .filter(e=>withinDays(e.date, days))
    .sort(compareForList)
    .forEach(e=>{
      const isTrainingOnly = e.training && (!e.sys && !e.dia && !e.pulse && !e.weight);
      const art = isTrainingOnly ? "Training" : "Messung";
      const notesText = isTrainingOnly ? ("🏋 Training" + (e.notes ? " – " + e.notes : "")) : (e.notes||"");
      const zeitLabel = e.context === "Morgen" ? `${e.time} (Morgens)` : e.context === "Abend" ? `${e.time} (Abends)` : e.time;
      const synced = e.remote_id ? "☁️" : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${e.date}</td>
        <td class="nowrap">${zeitLabel}</td>
        <td>${art}</td>
        <td class="center">${isTrainingOnly ? "" : (e.sys??"")}</td>
        <td class="center">${isTrainingOnly ? "" : (e.dia??"")}</td>
        <td class="center">${isTrainingOnly ? "" : (e.pulse??"")}</td>
        <td class="center">${isTrainingOnly ? "" : fmtNum(e.weight)}</td>
        <td class="center">${isTrainingOnly ? "" : fmtNum(e.map)}</td>
        <td class="notes">${nl2br(notesText)}</td>
        <td class="center">${e.training ? "Ja" : ""}</td>
        <td class="center">${e.low_intake ? "Ja" : ""}</td>
        <td class="center">${e.sick ? "Ja" : ""}</td>
        <td class="center">${e.valsartan_missed ? "Ja" : ""}</td>
        <td class="center">${e.forxiga_missed ? "Ja" : ""}</td>
        <td class="center">${e.nsar_taken ? "Ja" : ""}</td>
        <td class="center">${synced}</td>
        <td>
          <button class="btn ghost" data-del="${e.id}" data-remote="${e.remote_id ?? ''}">Löschen</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  if (!tbody.children.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="17" class="small" style="text-align:center;opacity:.7">Keine Einträge im ausgewählten Zeitraum</td>`;
    tbody.appendChild(tr);
  }

  $$("#tbl [data-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const localId = Number(btn.dataset.del);
      const remoteId = btn.dataset.remote || "";
      if(!confirm("Eintrag wirklich löschen? (falls vorhanden, auch in Supabase)")) return;

      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = "Lösche…";
      try{
        if(remoteId){
          const r = await deleteRemote(remoteId);
          if(!r.ok){
            alert("Server-Löschung fehlgeschlagen ("+(r.status||"?")+") – lokaler Eintrag wird NICHT gelöscht.");
            return;
          }
        }
        await deleteEntryLocal(localId);
        await loadAndRender();
        await renderDoctor();
        diag.add(remoteId ? "Löschung: Server + lokal OK" : "Löschung: lokal OK");
      } finally {
        btn.textContent = oldText;
        btn.disabled = false;
      }
    }, {passive:true});
  });
}
async function loadAndRender(){
  const entries = await getAllEntries();
  renderTable(entries);
}

/* ===== List rendering (Befunde) ===== */
async function loadAndRenderReports(){
  const reports = await getAllReports();
  const tbody = $("#tblReports tbody");
  tbody.innerHTML = "";

  reports
    .sort((a,b)=> b.ts - a.ts) // neueste zuerst
    .forEach(r=>{
      const synced = r.remote_id ? "☁️" : "";
      const tr = document.createElement("tr");
tr.innerHTML = `
  <td class="nowrap">${r.datum || ""}</td>
  <td class="center">${r.kreatinin != null ? Number(r.kreatinin).toFixed(2) : ""}</td>
  <td class="center">${r.egfr      != null ? Number(r.egfr).toFixed(0)      : ""}</td>
  <td class="center">${r.uacr      != null ? Number(r.uacr).toFixed(0)      : ""}</td>
  <td class="center">${r.kalium    != null ? Number(r.kalium).toFixed(1)    : ""}</td>
  <td class="notes">${nl2br(r.kommentar || "")}</td>
  <td class="center">${synced}</td>
  <td><button class="btn ghost" data-delrep="${r.id}" data-remote="${r.remote_id ?? ''}">Löschen</button></td>
`;


      tbody.appendChild(tr);
    });

  if(!tbody.children.length){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td colspan="8" class="small" style="text-align:center;opacity:.7">Keine Befunde vorhanden</td>`;
    tbody.appendChild(tr);
  }

  // Delete-Buttons
  $$("#tblReports [data-delrep]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const localId = Number(btn.dataset.delrep);
      const remoteId = btn.dataset.remote || "";
      if(!confirm("Befund wirklich löschen? (falls vorhanden, auch in Supabase)")) return;
      btn.disabled = true; const old=btn.textContent; btn.textContent = "Lösche…";
      try{
        if(remoteId){
          const r = await deleteRemoteBefund(remoteId);
          if(!r.ok){
            alert("Server-Löschung fehlgeschlagen ("+(r.status||"?")+") – lokaler Befund wird NICHT gelöscht.");
            return;
          }
        }
        await deleteReportLocal(localId);
        await loadAndRenderReports();
        diag.add(remoteId ? "Befund-Löschung: Server + lokal OK" : "Befund-Löschung: lokal OK");
      }finally{
        btn.disabled = false; btn.textContent = old;
      }
    }, {passive:true});
  });
}

/* ===== Doctor view (Daily) ===== */
async function renderDoctor(){
  const tbody = $("#doctorTable tbody");
  tbody.innerHTML = "";
  const from = $("#from").value;
  const to = $("#to").value;
  const entries = await getAllEntries();
  entries
    .filter(e=>{
      if (from && e.date < from) return false;
      if (to && e.date > to) return false;
      return true;
    })
    .sort((a,b)=>{
      const ta = (typeof a.ts === "number") ? a.ts : Date.parse(a.dateTime);
      const tb = (typeof b.ts === "number") ? b.ts : Date.parse(b.dateTime);
      return ta - tb;
    })
    .forEach(e=>{
      const isTrainingOnly = e.training && (!e.sys && !e.dia && !e.pulse && !e.weight);
      const art = isTrainingOnly ? "Training" : "Messung";
      const notesText = isTrainingOnly ? ("🏋 Training" + (e.notes ? " – " + e.notes : "")) : (e.notes||"");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.date}</td>
        <td>${e.time}</td>
        <td>${art}</td>
        <td>${isTrainingOnly ? "" : (e.sys??"")}</td>
        <td>${isTrainingOnly ? "" : (e.dia??"")}</td>
        <td>${isTrainingOnly ? "" : (e.pulse??"")}</td>
        <td>${isTrainingOnly ? "" : fmtNum(e.map)}</td>
        <td>${isTrainingOnly ? "" : fmtNum(e.weight)}</td>
        <td class="notes">${nl2br(notesText)}</td>
        <td>${e.low_intake ? "Ja" : ""}</td>
        <td>${e.sick ? "Ja" : ""}</td>
        <td>${e.valsartan_missed ? "Ja" : ""}</td>
        <td>${e.forxiga_missed ? "Ja" : ""}</td>
        <td>${e.nsar_taken ? "Ja" : ""}</td>
      `;
      tbody.appendChild(tr);
    });
  if (!tbody.children.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="14" class="small" style="text-align:center;opacity:.7">Keine Einträge im Zeitraum</td>`;
    tbody.appendChild(tr);
  }
}

/* ===== Simple SVG Chart (Daily) ===== */
const chartPanel = {
  el:null, svg:null, legend:null, open:false,
  init(){
    this.el = $("#chart"); this.svg = $("#chartSvg"); this.legend = $("#chartLegend");
    $("#chartClose").addEventListener("click", ()=>this.hide(), {passive:true});
    $("#chartBtn").addEventListener("click", async ()=>{ this.toggle(); await this.draw(); }, {passive:true});
    $("#refreshChart").addEventListener("click", ()=> this.draw(), {passive:true});
    $("#savePng").addEventListener("click", ()=> this.savePNG(), {passive:true});
    $("#metricSel").addEventListener("change", ()=> this.draw(), {passive:true});
    $("#smoothChk").addEventListener("change", ()=> this.draw(), {passive:true});
  },
  toggle(){ this.open=!this.open; this.el.style.display=this.open?'block':'none'; },
  hide(){ this.open=false; this.el.style.display='none'; },
  async getFiltered(){
    const entries = await getAllEntries();
    const from = $("#from").value; const to = $("#to").value;
    return entries.filter(e=>{ if (from && e.date < from) return false; if (to && e.date > to) return false; return true; })
                  .sort((a,b)=> ((a.ts ?? Date.parse(a.dateTime)) - (b.ts ?? Date.parse(b.dateTime))));
  },
  ma(arr, k=3){
    if(!$("#smoothChk").checked || k<=1) return arr;
    const out=[]; for(let i=0;i<arr.length;i++){
      const s = Math.max(0,i-Math.floor(k/2));
      const e = Math.min(arr.length-1,i+Math.floor(k/2));
      let sum=0, c=0; for(let j=s;j<=e;j++){ if(arr[j]!=null){ sum+=arr[j]; c++; } }
      out.push(c?sum/c:null);
    } return out;
  },
  async draw(){
    const metric = $("#metricSel").value;
    const data = await this.getFiltered();
    const xs = data.map(e => (e.ts ?? Date.parse(e.dateTime)));
    let series = [];
    if(metric==="bp"){
      const y1 = data.map(e => (e.sys!=null? Number(e.sys) : null));
      const y2 = data.map(e => (e.dia!=null? Number(e.dia) : null));
      series = [
        {name:"Systolisch", values:this.ma(y1), color:"#60a5fa"},
        {name:"Diastolisch", values:this.ma(y2), color:"#f472b6"}
      ];
    }else if(metric==="pulse"){
      const y = data.map(e => (e.pulse!=null? Number(e.pulse) : null));
      series = [{name:"Puls", values:this.ma(y), color:"#34d399"}];
    }else if(metric==="weight"){
      const y = data.map(e => (e.weight!=null? Number(e.weight) : null));
      series = [{name:"Gewicht (kg)", values:this.ma(y), color:"#f59e0b"}];
    }

    const hasAny = series.some(s => s.values.some(v=>v!=null));
    this.svg.innerHTML=""; this.legend.innerHTML="";
    if(!hasAny){ this.svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="#9aa3af" font-size="14">Keine darstellbaren Werte</text>`; return; }

    const W=640,H=280, PL=48, PR=16, PT=12, PB=28;
    const innerW=W-PL-PR, innerH=H-PT-PB;
    const xmin = Math.min(...xs.filter(Boolean));
    const xmax = Math.max(...xs.filter(Boolean));
    const allY = series.flatMap(s => s.values.filter(v=>v!=null));
    const ymin = Math.min(...allY);
    const ymax = Math.max(...allY);
    const ypad = Math.max( (ymax-ymin)*0.08, 1 );
    const y0 = ymin - ypad, y1max = ymax + ypad;

    const x = t => PL + ( (t - xmin) / Math.max(1,(xmax - xmin)) ) * innerW;
    const y = v => PT + (1 - ( (v - y0) / Math.max(1,(y1max - y0)) )) * innerH;

    function line(x1,y1,x2,y2, stroke, dash=""){ return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${stroke}" stroke-width="1" ${dash?`stroke-dasharray="${dash}"`:""} />`; }
    function text(tx,ty,str,anchor="end"){ return `<text x="${tx}" y="${ty}" fill="#9aa3af" font-size="11" text-anchor="${anchor}">${esc(str)}</text>`; }

    let grid = "";
    const ticks = 4;
    for(let i=0;i<=ticks;i++){
      const vv = y0 + (i*(y1max-y0)/ticks);
      const yy = y(vv);
      grid += line(PL,yy,W-PR,yy,"#22262f");
      grid += text(PL-6,yy+4, Math.round(vv).toString());
    }
    const week = 7*24*3600*1000;
    let start = xmin - (xmin % week) + week;
    for(let t=start; t<xmax; t+=week){
      const xx = x(t);
      grid += line(xx,PT,xx,H-PB,"#1b1f28","3 3");
      const d = new Date(t);
      const lbl = `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.`;
      grid += text(xx, H-8, lbl, "middle");
    }
    grid += line(PL,PT,PL,H-PB,"#2b2f3a");
    grid += line(PL,H-PB,W-PR,H-PB,"#2b2f3a");
    this.svg.insertAdjacentHTML("beforeend", grid);

    function pathFor(values, color){
      let d = "";
      values.forEach((v,i)=>{ if(v==null || !xs[i]) return; const cmd = (d==="" ? "M" : "L"); d += `${cmd}${x(xs[i]).toFixed(1)},${y(v).toFixed(1)} `; });
      return `<path d="${d}" fill="none" stroke="${color}" stroke-width="2.2" />`;
    }
    function dots(values, color){
      let out=""; values.forEach((v,i)=>{ if(v==null || !xs[i]) return; out += `<circle cx="${x(xs[i]).toFixed(1)}" cy="${y(v).toFixed(1)}" r="2.2" fill="${color}" />`; });
      return out;
    }
    series.forEach(s=>{
      this.svg.insertAdjacentHTML("beforeend", pathFor(s.values, s.color));
      this.svg.insertAdjacentHTML("beforeend", dots(s.values, s.color));
      const dot = document.createElement("span"); dot.className="dot"; dot.style.background=s.color;
      const label = document.createElement("span"); label.textContent = s.name;
      const wrap = document.createElement("span"); wrap.style.display="inline-flex"; wrap.style.alignItems="center"; wrap.style.gap="6px";
      wrap.appendChild(dot); wrap.appendChild(label); this.legend.appendChild(wrap);
    });
  },
  async savePNG(){
    const svgEl = this.svg;
    const xml = new XMLSerializer().serializeToString(svgEl);
    const svgBlob = new Blob([xml], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement("canvas");
      canvas.width = svgEl.viewBox.baseVal.width || 640;
      canvas.height = svgEl.viewBox.baseVal.height || 280;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#0f1116"; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0);
      canvas.toBlob(blob=>{
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `diagramm_${new Date().toISOString().slice(0,10)}.png`;
        a.click();
        URL.revokeObjectURL(a.href);
      },"image/png");
      URL.revokeObjectURL(url);
    };
    img.src = url;
  }
};

/* --- Button-Flash --- */
let saveFlashTimer = null;
function flashSaveOk(){
  const btn = document.getElementById('saveAllBtn');
  if(!btn) return;
  if (saveFlashTimer) { clearTimeout(saveFlashTimer); saveFlashTimer = null; }
  btn.disabled = true; btn.classList.add('flash'); btn.innerHTML = '✅ Gespeichert';
  saveFlashTimer = setTimeout(()=>{ btn.classList.remove('flash'); btn.innerHTML = '💾 Speichern'; btn.disabled = false; saveFlashTimer = null; }, 1000);
}

/* ===== Tabs ===== */
function setTab(name){
  $$(".view").forEach(v=>v.classList.remove("active"));
  $("#"+name).classList.add("active");
  $$(".tabs .btn").forEach(b=> b.classList.toggle("primary", b.dataset.tab===name));
  if(name==="doctor"){ renderDoctor(); }
  if(name==="list"){ loadAndRender(); }
}
function bindTabs(){
  const handler = (ev)=> setTab(ev.currentTarget.dataset.tab);
  $$(".tabs .btn").forEach(b=> b.addEventListener("click", handler, {passive:true}));
}

/* ===== Capture sub-modes ===== */
function bindCaptureSegment(){
  const seg = $("#seg-capture");
  if(!seg) return;
  seg.querySelectorAll(".seg-btn").forEach(b=>{
    b.addEventListener("click", ()=>{
      const mode = b.dataset.mode;
      seg.querySelectorAll(".seg-btn").forEach(x=>x.classList.toggle("active", x===b));
      $("#entry").classList.toggle("hidden", mode !== "daily");
      $("#entry_befund").classList.toggle("hidden", mode !== "befund");
    }, {passive:true});
  });
}

/* ===== List Umschaltung ===== */
function bindListSegment(){
  const seg = $("#seg-list");
  if(!seg) return;
  seg.querySelectorAll(".seg-btn").forEach(b=>{
    b.addEventListener("click", async ()=>{
      const mode = b.dataset.mode;
      seg.querySelectorAll(".seg-btn").forEach(x=>x.classList.toggle("active", x===b));
      $("#listDailyWrap").classList.toggle("hidden", mode!=="daily");
      $("#listReportWrap").classList.toggle("hidden", mode!=="befund");
      if(mode==="befund"){ await loadAndRenderReports(); }
      else { await loadAndRender(); }
    }, {passive:true});
  });
}

/* ===== Save flow (Daily) ===== */
let trainingActive=false, lowIntakeActive=false, sickActive=false, valsartanMissed=false, forxigaMissed=false, nsarTaken=false;
function setToggle(el, on, activeText, baseText){
  el.classList.toggle("active", !!on);
  el.setAttribute("aria-pressed", on ? "true" : "false");
  el.textContent = on ? activeText : baseText;
}
function setTraining(on){ trainingActive=!!on; setToggle($("#trainingToggle"), trainingActive, "🏋 Training heute (aktiv)", "🏋 Training heute"); }
function setLowIntake(on){ lowIntakeActive=!!on; setToggle($("#lowIntakeToggle"), lowIntakeActive, "🥤 < 2 L – aktiv", "🥤 < 2 L getrunken"); }
function setSick(on){
  sickActive=!!on; setToggle($("#sickToggle"), sickActive, "🤒 Krank (Forxiga pausiert) – aktiv", "🤒 Krank (Forxiga pausiert)");
  if(sickActive){ setForxigaMiss(true); $("#forxigaMissToggle").disabled=true; $("#forxigaMissToggle").style.opacity=0.6; }
  else { $("#forxigaMissToggle").disabled=false; $("#forxigaMissToggle").style.opacity=1; }
}
function setValsartanMiss(on){ valsartanMissed=!!on; setToggle($("#valsartanMissToggle"), valsartanMissed, "💊 Valsartan vergessen – aktiv", "💊 Valsartan vergessen"); }
function setForxigaMiss(on){ forxigaMissed=!!on; setToggle($("#forxigaMissToggle"), forxigaMissed, "💊 Forxiga vergessen – aktiv", "💊 Forxiga vergessen"); }
function setNsar(on){ nsarTaken=!!on; setToggle($("#nsarToggle"), nsarTaken, "🧪 NSAR genommen – aktiv", "🧪 NSAR genommen"); }

function blockHasData(which){
  return !!(
    $(`#time${which}`).value ||
    $(`#sys${which}`).value ||
    $(`#dia${which}`).value ||
    $(`#pulse${which}`).value ||
    $("#weightDay")?.value
  );
}
async function saveAll(){
  const hasM = blockHasData("M");
  const hasA = blockHasData("A");
  const weightVal = $("#weightDay")?.value;
  const mVitals = $("#timeM").value || $("#sysM").value || $("#diaM").value || $("#pulseM").value;
  const aVitals = $("#timeA").value || $("#sysA").value || $("#diaA").value || $("#pulseA").value;
  const weightOnly = !!(weightVal && !mVitals && !aVitals);

  let savedM = false, savedA = false;
  if(weightOnly){ savedM = await saveBlock("Morgen","M"); }
  else{
    if(hasM) savedM = await saveBlock("Morgen","M");
    if(hasA) savedA = await saveBlock("Abend","A");
  }
  if(!savedM && !savedA){ alert("Keine Daten eingegeben – nichts zu speichern."); return; }

  loadAndRender(); renderDoctor(); if(chartPanel.open) chartPanel.draw(); flashSaveOk();
}
async function saveBlock(contextLabel, which){
  if(!blockHasData(which)) return false;
  const date = $("#date").value || todayStr();
  const time = $(`#time${which}`).value || timeStr();
  const sys = $(`#sys${which}`).value ? Number($(`#sys${which}`).value) : null;
  const dia = $(`#dia${which}`).value ? Number($(`#dia${which}`).value) : null;
  const pulse = $(`#pulse${which}`).value ? Number($(`#pulse${which}`).value) : null;
  const weight = $("#weightDay")?.value ? Number($("#weightDay").value) : null;
  const dayNotes = $("#notesDay").value ? $("#notesDay").value.trim() : "";
  const currentISO = new Date(date+"T"+time).toISOString();
  const ts = new Date(date+"T"+time).getTime();

  const entry = {
    date, time, dateTime: currentISO, ts, context: contextLabel, arm: "links", position: "sitzend",
    sys, dia, pulse, weight, map: (sys!=null && dia!=null) ? calcMAP(sys, dia) : null,
    notes: dayNotes,
    training: trainingActive, low_intake: lowIntakeActive, sick: sickActive,
    valsartan_missed: valsartanMissed, forxiga_missed: forxigaMissed, nsar_taken: nsarTaken
  };

  const localId = await addEntry(entry);
  await syncWebhook(entry, localId);
  return true;
}

/* ===== Save flow (Befund) ===== */
async function saveReport(){
  const datum = $("#repDate").value || todayStr();
  const report = {
    datum,
    kreatinin: $("#repKrea").value ? Number($("#repKrea").value) : null,
    egfr:      $("#repEgfr").value ? Number($("#repEgfr").value) : null,
    uacr:      $("#repUacr").value ? Number($("#repUacr").value) : null,
    kalium:    $("#repK").value    ? Number($("#repK").value)    : null,
    kommentar: $("#repNote").value?.trim() || "",
    source: "manuell",
    ts: new Date(datum+"T00:00:00").getTime()
  };
  const localId = await addReport(report);
  await syncReportWebhook(report, localId);

  const btn = $("#saveReportBtn");
  const old = btn.innerHTML; btn.disabled=true; btn.classList.add("flash"); btn.innerHTML="✅ Befund gespeichert";
  setTimeout(()=>{ btn.classList.remove("flash"); btn.innerHTML=old; btn.disabled=false; },800);

  ["#repKrea","#repEgfr","#repUacr","#repK","#repNote"].forEach(sel=>{ const el=$(sel); if(el) el.value=""; });
}

/* ===== Webhook Sync (Daily) ===== */
async function syncWebhook(entry, localId){
  const url = await getConf("webhookUrl");
  const headers = await getHeaders();
  if(!url || !headers) return;

  try{
    const res = await fetch(url, { method:"POST", headers, body: JSON.stringify(entry) });
    if(!res.ok){
      diag.add(`Webhook-Fehler ${res.status}`);
      return;
    }
    const json = await res.json();
    const remoteId = json?.[0]?.id;
    if(remoteId!=null){
      await updateEntry(localId, { remote_id: remoteId });
      diag.add("Webhook: OK");
    }
  }catch(e){
    diag.add("Webhook: Netzwerkfehler");
  }
}

/* ===== Main ===== */
async function main(){
  diag.init(); helpPanel.init(); await initDB();
  chartPanel.init(); bindTabs();
  $("#date").value = todayStr();
  $("#timeM").value = "07:00"; $("#timeA").value = "19:00";
  $("#from").value = new Date(Date.now()-30*24*3600*1000).toISOString().slice(0,10);
  $("#to").value = todayStr();
  setTab("capture");

  // Konfiguration laden
  const savedUrl = await getConf("webhookUrl");
  const savedKey = await getConf("webhookKey");
  const savedMrUrl = await getConf("webhookUrlMr");
  if (savedUrl) $("#whUrl").value = savedUrl;
  if (savedKey) $("#whKey").value = savedKey;
  if (savedMrUrl) $("#whUrlMr").value = savedMrUrl;

  // Sanfte Warnung
  ["#sysM","#diaM","#pulseM","#sysA","#diaA","#pulseA","#weightDay"].forEach(sel=>{
    const el = $(sel); if(!el) return;
    el.addEventListener("input", ()=>{
      if (sel.includes("sys"))        softWarnRange(el, 70, 220);
      else if (sel.includes("dia"))   softWarnRange(el, 40, 140);
      else if (sel.includes("pulse")) softWarnRange(el, 30, 180);
      else if (sel.includes("weight"))softWarnRange(el, 30, 300);
    }, {passive:true});
  });

  // Toggle-Handler
  const bindToggle = (id, setter, getVal)=>{ const el=$(id); const h=()=> setter(!getVal()); el.addEventListener("click", h, {passive:true}); };
  bindToggle("#trainingToggle", setTraining, ()=>trainingActive);
  bindToggle("#lowIntakeToggle", setLowIntake, ()=>lowIntakeActive);
  bindToggle("#sickToggle", setSick, ()=>sickActive);
  bindToggle("#valsartanMissToggle", setValsartanMiss, ()=>valsartanMissed);
  bindToggle("#forxigaMissToggle", setForxigaMiss, ()=>forxigaMissed);
  bindToggle("#nsarToggle", setNsar, ()=>nsarTaken);

  $("#saveAllBtn").addEventListener("click", saveAll, {passive:true});
  $("#applyRange").addEventListener("click", ()=>{ renderDoctor(); if(chartPanel.open) chartPanel.draw(); }, {passive:true});
  $("#printBtn").addEventListener("click", ()=> window.print(), {passive:true});

  document.addEventListener('keydown', (e)=>{
    const isSave = (e.key.toLowerCase()==='s') && (e.ctrlKey || e.metaKey);
    if(isSave){ e.preventDefault(); saveAll(); }
  });

  $("#rangeSel").addEventListener("change", loadAndRender);
  $("#exportCsv").addEventListener("click", async ()=>{ const all = await getAllEntries(); dl("gesundheitslog.csv", toCSV(all), "text/csv"); });
  $("#exportJson").addEventListener("click", async ()=>{ const all = await getAllEntries(); dl("gesundheitslog.json", JSON.stringify(all,null,2), "application/json"); });
  $("#wipeBtn").addEventListener("click", async ()=>{ if(confirm("Alle lokalen Daily-Einträge löschen?")){ await wipeAll(); loadAndRender(); renderDoctor(); if(chartPanel.open) chartPanel.draw(); } });

  $("#saveWebhook").addEventListener("click", async ()=>{
    await putConf("webhookUrl", $("#whUrl").value.trim());
    await putConf("webhookKey", $("#whKey").value.trim());
    await putConf("webhookUrlMr", $("#whUrlMr").value.trim());
    $("#whSaved").textContent = "Gespeichert ✓";
    setTimeout(()=>$("#whSaved").textContent="", 2000);
  });

  // MANUELLER SYNC (Daily)
  $("#syncBtn").addEventListener("click", async ()=>{
    if(!confirm("SYNC (Daily) startet:\n1) Backup CSV herunterladen\n2) Ausstehende lokale Einträge an Supabase senden\n3) Lokale Liste leeren\n4) Frische Daten von Supabase laden\nFortfahren?")) return;
    setBusy(true);
    $("#syncBtn").disabled = true;
    try{
      const current = await getAllEntries();
      dl("backup_vor_sync.csv", toCSV(current), "text/csv");
      const resPush = await pushPendingToRemote();
      diag.add(`SYNC: Pending gepusht → OK=${resPush.pushed}, FAIL=${resPush.failed}`);
      await wipeAll();
      const remoteRows = await pullAllFromRemote();
      for(const r of remoteRows){
        const entry = {
          date: r.date, time: r.time, dateTime: r.dateTime, ts: r.ts, context: r.context,
          arm: r.arm, position: r.position, sys: r.sys, dia: r.dia, pulse: r.pulse,
          weight: r.weight, map: r.map, notes: r.notes,
          training: r.training, low_intake: r.low_intake, sick: r.sick,
          valsartan_missed: r.valsartan_missed, forxiga_missed: r.forxiga_missed, nsar_taken: r.nsar_taken,
          remote_id: r.id
        };
        await addEntry(entry);
      }
      await loadAndRender(); await renderDoctor();
      if(chartPanel.open) await chartPanel.draw();
      diag.add(`SYNC: ${remoteRows.length} Einträge vom Server geladen`);
      alert("Sync abgeschlossen.");
    }catch(e){
      console.error(e); alert("Sync fehlgeschlagen: "+(e.message||e));
    } finally {
      $("#syncBtn").disabled = false;
      setBusy(false);
    }
  });

  // Bind Segmented Controls
  bindCaptureSegment();
  bindListSegment();

  // Befund speichern
  $("#saveReportBtn").addEventListener("click", saveReport, {passive:true});

  // Initial
  loadAndRender(); renderDoctor();
}

/* boot */
main();
</script>
</body>
</html>
